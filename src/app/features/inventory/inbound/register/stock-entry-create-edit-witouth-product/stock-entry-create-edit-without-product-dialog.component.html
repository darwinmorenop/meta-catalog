<h2 mat-dialog-title>Entrada física - {{ data.isEdit ? 'Editar Producto' : 'Añadir Producto' }}</h2>

<mat-dialog-content class="dialog-content">
  <!-- Selection Section (only if not editing or if we want to change) -->
  <div class="selection-section" *ngIf="!data.isEdit || !selectedProduct()">
    <h3>Seleccionar Producto</h3>
    <app-smart-table
      [data]="tableData()"
      [config]="tableConfig"
      [isLoading]="productsResource.isLoading()"
      (selectionChange)="onSelectionChange($event)">
    </app-smart-table>
  </div>

  <!-- Selected Product Info -->
  <div class="selected-info" *ngIf="selectedProduct()">
    <div class="product-badge">
      <img [src]="selectedProduct().product_image || selectedProduct().img_main || 'assets/images/placeholder.png'" alt="Product">
      <div class="details">
        <span class="name">{{ selectedProduct().product_name || selectedProduct().name }}</span>
        <span class="sku">SKU: {{ selectedProduct().product_sku || selectedProduct().sku }}</span>
      </div>
    </div>
  </div>

  <!-- Form Section -->
  <form [formGroup]="form" class="product-form" *ngIf="selectedProduct()">
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Cantidad</mat-label>
        <input matInput type="number" formControlName="quantity" placeholder="0">
        <mat-icon matPrefix>inventory</mat-icon>
        <mat-error *ngIf="form.get('quantity')?.hasError('required')">Requerido</mat-error>
        <mat-error *ngIf="form.get('quantity')?.hasError('min')">Mínimo 1</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Costo Unitario</mat-label>
        <input matInput type="number" formControlName="unit_cost" placeholder="0.00">
        <mat-icon matPrefix>payments</mat-icon>
        <mat-error *ngIf="form.get('unit_cost')?.hasError('required')">Requerido</mat-error>
        <mat-error *ngIf="form.get('unit_cost')?.hasError('min')">Mínimo 0</mat-error>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Lote (Batch Number)</mat-label>
        <input matInput formControlName="batch_number" placeholder="Opcional">
        <mat-icon matPrefix>tag</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha Expiración</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="expiry_date">
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-icon matPrefix>event_busy</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="description" placeholder="Opcional"></textarea>
        <mat-icon matPrefix>description</mat-icon>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="close()">Cancelar</button>
  <button mat-flat-button color="primary" [disabled]="form.invalid || !selectedProduct()" (click)="save()">
    {{ data.isEdit ? 'Actualizar' : 'Añadir a la lista' }}
  </button>
</mat-dialog-actions>
