<div class="table-wrapper">
    @if (isLoading) {
    <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    }

    @if (data.length > 0) {
    <div class="filter-section">
        <mat-form-field appearance="outline" class="global-search">
            <mat-label>BÃºsqueda Global</mat-label>
            <input matInput [(ngModel)]="globalFilter" (keyup)="applyFilters()" [placeholder]="searchablePlaceholder">
        </mat-form-field>

        <div class="filter-actions">
            <button mat-stroked-button (click)="openFilterDialog()" class="filter-button" [class.active-filters]="hasActiveFilters()">
                <mat-icon>filter_list</mat-icon>
                <span>Filtros</span>
                @if (getActiveFilterCount() > 0) {
                    <span class="filter-badge">{{ getActiveFilterCount() }}</span>
                }
            </button>
        </div>
    </div>

    @if (hasActiveFilters()) {
        <div class="active-filters-row">
            <span class="active-filters-label">Filtros activos:</span>
            <mat-chip-set class="active-chips">
                @for (colKey of columnFilters | keyvalue; track colKey.key) {
                    @for (val of $any(colKey.value); track val) {
                        <mat-chip-row [removable]="true" (removed)="removeFilter(colKey.key, val)">
                            <span class="chip-col-header">{{ getColumnHeader(colKey.key) }}:</span>
                            <span class="chip-val">{{ getLabel(colKey.key, val) }}</span>
                            <button matChipRemove>
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip-row>
                    }
                }
            </mat-chip-set>
        </div>
    }

    <div class="table-container mat-elevation-z8">
        <table mat-table [dataSource]="dataSource" matSort>

            @for (col of config.columns; track col.key) {
            <ng-container [matColumnDef]="col.key">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> {{col.header}} </th>
                <td mat-cell *matCellDef="let element">
                    @switch (col.type) {
                        @case ('badge') {
                        @let badge = getBadgeInfo(element[col.key]);
                        <span class="smart-table-badge"
                            [style.background-color]="badge.color ? badge.color + '1A' : 'var(--surface-hover)'"
                            [style.color]="badge.color || 'var(--text-secondary)'"
                            [style.border-color]="badge.color ? badge.color : 'var(--border-color)'">
                            {{badge.label}}
                        </span>
                        }

                        @case ('currency') {
                        <span>
                            {{ element[col.key] | currency:'EUR':'symbol':'1.2-2' }}
                        </span>
                        }

                        @case ('date') {
                        <span>
                            {{ element[col.key] | date: 'dd/MM/yyyy' }}
                        </span>
                        }

                        @case ('datetime') {
                        <span>
                            {{ element[col.key] | date: 'dd/MM/yyyy HH:mm' }}
                        </span>
                        }

                        @case ('image') {
                        <div class="image-cell">
                            <img [src]="element[col.key]" class="row-image">
                        </div>
                        }

                        @case ('config') {
                        <div class="config-icons">
                            @for (iconConfig of element[col.key]; track iconConfig.icon) {
                                @if (iconConfig.active) {
                                <mat-icon 
                                    [color]="iconConfig.color || 'primary'" 
                                    [title]="iconConfig.tooltip || ''">
                                    {{iconConfig.icon}}
                                </mat-icon>
                                }
                            }
                        </div>
                        }

                        @case ('boolean') {
                        <div class="boolean-cell">
                            <mat-icon [color]="element[col.key] ? 'primary' : 'disabled'">
                                {{ element[col.key] ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </div>
                        }

                        @case ('chips') {
                        <div class="chips-cell">
                            <mat-chip-set>
                                @for (chip of element[col.key]; track chip) {
                                    @let chipInfo = getBadgeInfo(chip);
                                    <mat-chip highlighted 
                                        [style.background-color]="chipInfo.color ? chipInfo.color + '1A' : 'var(--surface-hover)'"
                                        [style.color]="chipInfo.color || 'var(--text-secondary)'">
                                        {{ chipInfo.label }}
                                    </mat-chip>
                                }
                            </mat-chip-set>
                        </div>
                        }

                        @default {
                        <span>
                            {{ element[col.key] }}
                        </span>
                        }
                    }
                </td>
            </ng-container>
            }

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Acciones </th>
                <td mat-cell *matCellDef="let element">
                    @if (config.actions?.view) {
                    <button mat-icon-button color="primary" 
                        (click)="view.emit(element); $event.stopPropagation();"
                        [disabled]="element.smart_table_view_disabled">
                        <mat-icon>{{element.smart_table_view_icon || config.actions?.viewIcon}}</mat-icon>
                    </button>
                    }
                    @if (config.actions?.edit) {
                    <button mat-icon-button color="primary" 
                        (click)="edit.emit(element); $event.stopPropagation()"
                        [disabled]="element.smart_table_edit_disabled">
                        <mat-icon>{{element.smart_table_edit_icon || config.actions?.editIcon}}</mat-icon>
                    </button>
                    }
                    @if (config.actions?.delete) {
                    <button mat-icon-button color="warn" 
                        (click)="delete.emit(element); $event.stopPropagation()"
                        [disabled]="element.smart_table_delete_disabled">
                        <mat-icon>{{element.smart_table_delete_icon || config.actions?.deleteIcon}}</mat-icon>
                    </button>
                    }
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectRow(row)"
                [class.selected-row]="selectedRow === row">
            </tr>
        </table>

        <mat-paginator [pageSizeOptions]="config.pageSizeOptions" showFirstLastButtons></mat-paginator>
    </div>
    } @else if (!isLoading) {
        <div class="empty-state">
            <p>No hay datos para mostrar.</p>
        </div>
    }
</div>
