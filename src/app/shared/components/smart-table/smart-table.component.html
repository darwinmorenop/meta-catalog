<div class="table-wrapper">
    <div class="loading-overlay" *ngIf="isLoading">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div class="filter-section" *ngIf="data.length > 0">
        <mat-form-field appearance="outline" class="global-search">
            <mat-label>BÃºsqueda Global</mat-label>
            <input matInput [(ngModel)]="globalFilter" (keyup)="applyFilters()" placeholder="Buscar en todo...">
        </mat-form-field>

        <div class="column-filters">
            <ng-container *ngFor="let col of config.columns">
                <mat-form-field *ngIf="col.filterable" appearance="outline" class="col-filter">
                    <mat-label>Filtrar {{col.header}}</mat-label>
                    <mat-select [(ngModel)]="columnFilters[col.key]" (selectionChange)="applyFilters()">
                        <div class="search-select-container">
                            <input matInput (keyup)="filterOptionsList(col.key, $event)"
                                (keydown)="$event.stopPropagation()" placeholder="Buscar..." class="search-select-input">
                        </div>
                        <mat-option value="">Todos</mat-option>
                        <mat-option *ngFor="let val of filteredFilterOptions[col.key]" [value]="val">
                            <ng-container [ngSwitch]="col.type">
                                <ng-container *ngSwitchCase="'boolean'">
                                    {{ val === 'true' ? 'SI' : 'NO' }}
                                </ng-container>
                                <ng-container *ngSwitchDefault>
                                    {{ val }}
                                </ng-container>
                            </ng-container>
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </ng-container>
        </div>
    </div>

    <div class="table-container mat-elevation-z8" *ngIf="data.length > 0; else noData">
        <table mat-table [dataSource]="dataSource" matSort>

            <ng-container *ngFor="let col of config.columns" [matColumnDef]="col.key">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> {{col.header}} </th>
                <td mat-cell *matCellDef="let element">
                    <ng-container [ngSwitch]="col.type">
                        <!-- Badge Type -->
                        <span *ngSwitchCase="'badge'" [class.stock-ok]="element[col.key] === 'in stock'"
                            [class.stock-out]="element[col.key] === 'out of stock'"
                            [class.state-new]="element[col.key] === 'new'"
                            [class.state-changed]="element[col.key] === 'changed'">
                            {{element[col.key]}}
                        </span>

                        <!-- Currency Type (Simple placeholder) -->
                        <span *ngSwitchCase="'currency'">
                            {{ element[col.key] | currency:'EUR':'symbol':'1.2-2' }}
                        </span>

                        <!-- Date Type -->
                        <span *ngSwitchCase="'date'">
                            {{ element[col.key] | date: 'dd/MM/yyyy HH:mm' }}
                        </span>

                        <!-- Image Type -->
                        <div *ngSwitchCase="'image'" class="image-cell">
                            <img [src]="element[col.key]" class="row-image">
                        </div>

                        <!-- Config Type (Generic Icons) -->
                        <div *ngSwitchCase="'config'" class="config-icons">
                            <ng-container *ngFor="let iconConfig of element[col.key]">
                                <mat-icon 
                                    *ngIf="iconConfig.active" 
                                    [color]="iconConfig.color || 'primary'" 
                                    [title]="iconConfig.tooltip || ''">
                                    {{iconConfig.icon}}
                                </mat-icon>
                            </ng-container>
                        </div>

                        <!-- Boolean Type -->
                        <div *ngSwitchCase="'boolean'" class="boolean-cell">
                            <mat-icon [color]="element[col.key] ? 'primary' : 'disabled'">
                                {{ element[col.key] ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </div>

                        <!-- Default Text -->
                        <span *ngSwitchDefault>
                            {{ element[col.key] }}
                        </span>
                    </ng-container>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Acciones </th>
                <td mat-cell *matCellDef="let element">
                    <button *ngIf="config.actions?.view" mat-icon-button color="primary" (click)="view.emit(element); $event.stopPropagation();">
                        <mat-icon>{{config.actions?.viewIcon}}</mat-icon>
                    </button>
                    <button *ngIf="config.actions?.edit" mat-icon-button color="primary" (click)="edit.emit(element); $event.stopPropagation()">
                        <mat-icon>{{config.actions?.editIcon}}</mat-icon>
                    </button>
                    <button *ngIf="config.actions?.delete" mat-icon-button color="warn" (click)="delete.emit(element); $event.stopPropagation()">
                        <mat-icon>{{config.actions?.deleteIcon}}</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectRow(row)"
                [class.selected-row]="selectedRow === row">
            </tr>
        </table>

        <mat-paginator [pageSizeOptions]="config.pageSizeOptions" showFirstLastButtons></mat-paginator>
    </div>
</div>

<ng-template #noData>
    <div class="empty-state" *ngIf="!isLoading">
        <p>No hay datos para mostrar.</p>
    </div>
</ng-template>
