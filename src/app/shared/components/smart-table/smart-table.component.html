<div class="table-wrapper">
    @if (isLoading) {
    <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    }

    @if (data.length > 0) {
    <div class="filter-section">
        <mat-form-field appearance="outline" class="global-search">
            <mat-label>BÃºsqueda Global</mat-label>
            <input matInput [(ngModel)]="globalFilter" (keyup)="applyFilters()" [placeholder]="searchablePlaceholder">
        </mat-form-field>

        <div class="column-filters">
            @for (col of config.columns; track col.key) {
                @if (col.filterable) {
                <mat-form-field appearance="outline" class="col-filter">
                    <mat-label>Filtrar {{col.header}}</mat-label>
                    <mat-select [(ngModel)]="columnFilters[col.key]" (selectionChange)="applyFilters()">
                        <div class="search-select-container">
                            <input matInput (keyup)="filterOptionsList(col.key, $event)"
                                (keydown)="$event.stopPropagation()" placeholder="Buscar..." class="search-select-input">
                        </div>
                        <mat-option value="">Todos</mat-option>
                        @for (val of filteredFilterOptions[col.key]; track val) {
                        <mat-option [value]="val">
                            @switch (col.type) {
                                @case ('boolean') {
                                    {{ val === 'true' ? 'SI' : 'NO' }}
                                }
                                @default {
                                    {{ val }}
                                }
                            }
                        </mat-option>
                        }
                    </mat-select>
                </mat-form-field>
                }
            }
        </div>
    </div>

    <div class="table-container mat-elevation-z8">
        <table mat-table [dataSource]="dataSource" matSort>

            @for (col of config.columns; track col.key) {
            <ng-container [matColumnDef]="col.key">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> {{col.header}} </th>
                <td mat-cell *matCellDef="let element">
                    @switch (col.type) {
                        @case ('badge') {
                        <span [class.stock-ok]="element[col.key] === 'in stock'"
                            [class.stock-out]="element[col.key] === 'out of stock'"
                            [class.state-new]="element[col.key] === 'new'"
                            [class.state-changed]="element[col.key] === 'changed'">
                            {{element[col.key]}}
                        </span>
                        }

                        @case ('currency') {
                        <span>
                            {{ element[col.key] | currency:'EUR':'symbol':'1.2-2' }}
                        </span>
                        }

                        @case ('date') {
                        <span>
                            {{ element[col.key] | date: 'dd/MM/yyyy' }}
                        </span>
                        }

                        @case ('datetime') {
                        <span>
                            {{ element[col.key] | date: 'dd/MM/yyyy HH:mm' }}
                        </span>
                        }

                        @case ('image') {
                        <div class="image-cell">
                            <img [src]="element[col.key]" class="row-image">
                        </div>
                        }

                        @case ('config') {
                        <div class="config-icons">
                            @for (iconConfig of element[col.key]; track iconConfig.icon) {
                                @if (iconConfig.active) {
                                <mat-icon 
                                    [color]="iconConfig.color || 'primary'" 
                                    [title]="iconConfig.tooltip || ''">
                                    {{iconConfig.icon}}
                                </mat-icon>
                                }
                            }
                        </div>
                        }

                        @case ('boolean') {
                        <div class="boolean-cell">
                            <mat-icon [color]="element[col.key] ? 'primary' : 'disabled'">
                                {{ element[col.key] ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </div>
                        }

                        @default {
                        <span>
                            {{ element[col.key] }}
                        </span>
                        }
                    }
                </td>
            </ng-container>
            }

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Acciones </th>
                <td mat-cell *matCellDef="let element">
                    @if (config.actions?.view) {
                    <button mat-icon-button color="primary" 
                        (click)="view.emit(element); $event.stopPropagation();"
                        [disabled]="element.smart_table_view_disabled">
                        <mat-icon>{{config.actions?.viewIcon}}</mat-icon>
                    </button>
                    }
                    @if (config.actions?.edit) {
                    <button mat-icon-button color="primary" 
                        (click)="edit.emit(element); $event.stopPropagation()"
                        [disabled]="element.smart_table_edit_disabled">
                        <mat-icon>{{config.actions?.editIcon}}</mat-icon>
                    </button>
                    }
                    @if (config.actions?.delete) {
                    <button mat-icon-button color="warn" 
                        (click)="delete.emit(element); $event.stopPropagation()"
                        [disabled]="element.smart_table_delete_disabled">
                        <mat-icon>{{config.actions?.deleteIcon}}</mat-icon>
                    </button>
                    }
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectRow(row)"
                [class.selected-row]="selectedRow === row">
            </tr>
        </table>

        <mat-paginator [pageSizeOptions]="config.pageSizeOptions" showFirstLastButtons></mat-paginator>
    </div>
    } @else if (!isLoading) {
        <div class="empty-state">
            <p>No hay datos para mostrar.</p>
        </div>
    }
</div>
